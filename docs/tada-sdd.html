<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>TADA (Telescope Automatic Data Archiver) SDD</title>
<!-- 2014-11-07 Fri 08:50 -->
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Steve Pothier" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">TADA (Telescope Automatic Data Archiver) SDD</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">About this document</a></li>
<li><a href="#sec-2">Overview</a></li>
<li><a href="#sec-3">Config</a>
<ul>
<li><a href="#sec-3-1">iinit</a></li>
<li><a href="#sec-3-2">irod directory structure</a></li>
</ul>
</li>
<li><a href="#sec-4">As-Built</a>
<ul>
<li><a href="#sec-4-1">Changes from iDCI</a></li>
<li><a href="#sec-4-2"><span class="timestamp-wrapper"><span class="timestamp">&lt;2014-10-24 Fri&gt;</span></span></a>
<ul>
<li><a href="#sec-4-2-1">Thread-2: Touches FITS data  (verifies selected metadata in archive)</a></li>
<li><a href="#sec-4-2-2">Open Issues</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#sec-5">Sprint user stories</a>
<ul>
<li><a href="#sec-5-1">Thread-1: Establishes file move to archive and test</a>
<ul>
<li><a href="#sec-5-1-1"></a></li>
</ul>
</li>
<li><a href="#sec-5-2">Thread-2: Touches FITS data  (verifies selected metadata in archive)</a>
<ul>
<li><a href="#sec-5-2-1"></a></li>
</ul>
</li>
<li><a href="#sec-5-3">Thread-3: Split into 2 machines, use iRODS client/server</a>
<ul>
<li><a href="#sec-5-3-1"></a></li>
</ul>
</li>
<li><a href="#sec-5-4">LATER</a></li>
</ul>
</li>
<li><a href="#sec-6">Classes of supporting machines (hosts)</a></li>
<li><a href="#sec-7">Goals</a>
<ul>
<li><a href="#sec-7-1">Prove its done right</a></li>
</ul>
</li>
<li><a href="#sec-8">Secondary Goals</a></li>
<li><a href="#sec-9">Requirements</a>
<ul>
<li><a href="#sec-9-1">General systemic requirements</a></li>
<li><a href="#sec-9-2">Candidate requirements</a></li>
<li><a href="#sec-9-3">From 2010 iDCI project definition</a></li>
<li><a href="#sec-9-4">TADA migration from 2010 iDCI project requriements</a></li>
<li><a href="#sec-9-5">Meta data required for ingest into archive</a></li>
<li><a href="#sec-9-6">MVP - Minimally Viable Product</a></li>
<li><a href="#sec-9-7">Release 2</a></li>
<li><a href="#sec-9-8">Deferred requirements</a></li>
</ul>
</li>
<li><a href="#sec-10">Open Issues</a>
<ul>
<li><a href="#sec-10-1">Which files from input list ("printed" files) should get moved to archive?</a></li>
<li><a href="#sec-10-2">What if FITS files do NOT contain minimum required metadata (fields/values)?</a></li>
<li><a href="#sec-10-3">What are the expected workflows?</a></li>
</ul>
</li>
<li><a href="#sec-11">Closed Issues</a></li>
<li><a href="#sec-12">Assumptions</a></li>
<li><a href="#sec-13">DEFERRED</a>
<ul>
<li><a href="#sec-13-1">(mountain) copy and morph</a></li>
<li><a href="#sec-13-2">FPACK before transmit from Mountain to Valley</a></li>
<li><a href="#sec-13-3">sdpost writes to /tmp/mountaincache</a></li>
</ul>
</li>
<li><a href="#sec-14">Release checklist</a>
<ul>
<li><a href="#sec-14-1">Maintainability</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">About this document</h2>
<div class="outline-text-2" id="text-1">
<p>
This document is intended for system software developers and
maintainers.  It may also be shared with decision makers to provide
a common context including requirements, goals, and plans.  The
primary audiance is employees of NOAO, but an attempt was made to keep
it general enough for use in other domains.
</p>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Overview</h2>
<div class="outline-text-2" id="text-2">
<p>
The software described here is: <i>TADA (Telescope Automatic Data Archiver)</i>
The purpose of TADA is to provide an end-to-end flow of data from
telescope instruments to archives at machines around the world. By its
very nature, TADA is a multi-machine system.  A more general
formulation of the purpose might be:
</p>
<blockquote>
<p>
Collect data from remote instruments and save in nearby
cache. Transfer cache data to a local archive, removing cache data
after it has been successfully transfer.
</p>
</blockquote>


<p>
This System Design Document (SDD) attempts to describe software as
built. Since the document and software are being written at the same
time, they may not match until the project is completed. (Maybe not
even then!  If in doubt ask me (Steve P).
</p>

<p>
The project must proceed without the benefit of known
requirements. Therefore, development will proceed with a series of
alpha releases that represent various "threads through the system".
Each thread may contain arbitrary amounts of mockup code but will at
the very least simulate the end-to-end flow of data.  Later
alpha-versions will contain progressively more real (non-mockup)
components. The first beta release will contain no-mockup for the
thread but may contain mocked up modules on either side of the
thread. e.g. A mockup will pretend to be telescope instruments sending
data. 
</p>

<p>
At each alpha-release, stake-holders have the opportunity to affect
what is done for the next release.  Its <b>very important</b> for
stake-holders to provide prompt feedback.  In the absence of such
feedback, developers will simply guess on what is important next and
move on.  
</p>

<p>
We refer to "mountain" and "valley" sites/machines.  These aren't
necessarily to be taken literally. "Mountain" means the computer(s)
connected to telescope instruments directly or through LAN. The
connection is assumed to be very unlikely to be lost unless the
instruments and computers go down also.  "Valley" emans the
computer(s) far away from the telescope instruments and connected
only the internet. 
</p>

<p>
The software described here is intended to solve a general problem &#x2013;
collecting remote data and storing in an archive without loss in the
face of failures in hardware and software.  But the document focuses
on that problem in a more specific domain (optical astronomy data).
Where there are domain specific issues, they will be described
elsewhere but links retained from this document to those domain
specific issues.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">Config</h2>
<div class="outline-text-2" id="text-3">
</div><div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1">iinit</h3>
<div class="outline-text-3" id="text-3-1">
<p>
irodsHost valley
irodsPort 1247
irodsUserName rods
irodsZone tempZone
</p>
</div>
</div>
<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2">irod directory structure</h3>
<div class="outline-text-3" id="text-3-2">
<pre class="example">
/sd_zone/
        from_cache/
        for_archive/
</pre>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">As-Built</h2>
<div class="outline-text-2" id="text-4">
<p>
This section documents specific builds.  When a requirement or feature
is described outside of the <i>As-Built</i> section, it should be
considered a future possibility, <b>not</b> something that has been
implemented. 
</p>

<p>
I record dated sub-sections below but will typically hide all but the
most recent.  Ask if you want it for some reason.
</p>
</div>

<div id="outline-container-sec-4-1" class="outline-3">
<h3 id="sec-4-1">Changes from iDCI</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>All files "printed" from telescope are sent to valley.
</li>
<li></li>
</ul>
</div>
</div>

<div id="outline-container-sec-4-2" class="outline-3">
<h3 id="sec-4-2"><span class="timestamp-wrapper"><span class="timestamp">&lt;2014-10-24 Fri&gt;</span></span></h3>
<div class="outline-text-3" id="text-4-2">
</div><div id="outline-container-sec-4-2-1" class="outline-4">
<h4 id="sec-4-2-1">Thread-2: Touches FITS data  (verifies selected metadata in archive)</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Given a "source directory" tree that may contain FITS files, 
</p>
</div>
</div>
<div id="outline-container-sec-4-2-2" class="outline-4">
<h4 id="sec-4-2-2">Open Issues</h4>
<div class="outline-text-4" id="text-4-2-2">
<ul class="org-ul">
<li>Which files from input list ("printed" files) should get moved to archive?
<ul class="org-ul">
<li>DEFAULT ANSWER: only *.fitz.fz
</li>
</ul>
</li>

<li>What if a FITS file does NOT contain minimum required metadata?
<ul class="org-ul">
<li>DEFAULT ANSWER: Reject file, move to remediation store, log error
</li>
</ul>
</li>

<li>What is the minium required metadata?
<ul class="org-ul">
<li>DEFAULT ANSWER: Presence of following fields in FITS hdr without
regard to their value:
<ul class="org-ul">
<li>DATE-OBS
</li>
<li>DTACQNAM
</li>
<li>DTINSTRU
</li>
<li>DTNSANAM
</li>
<li>DTPI
</li>
<li>DTSITE
</li>
<li>DTSITE
</li>
<li>DTTELESC
</li>
<li>DTTITLE
</li>
<li>DTUTC
</li>
<li>PROPID
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">Sprint user stories</h2>
<div class="outline-text-2" id="text-5">
<p>
These are the expect outcomes from progressively more complex <a href="https://www.scrum.org/">scrum</a> sprints.
</p>

<p>
In our case "user" means two kinds of people: 
</p>
<ol class="org-ol">
<li>scientist that want access to data,
</li>
<li>SDM DevOps employees that need to manage the process
</li>
</ol>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1">Thread-1: Establishes file move to archive and test</h3>
<div class="outline-text-3" id="text-5-1">
<p>
This is minimal "thread through the system" starting at raw-data and
terminating with files in the archive.
</p>
<ul class="org-ul">
<li><code>[X]</code> mock-LPR;  Feed each file in list to Ingest after random delay
</li>
<li><code>[X]</code> Ingest;  Copy file into mock-IRODS (a local filesystem)
</li>
<li><code>[X]</code> Test;  Verify all input files are  in mock-IRODS
</li>
</ul>
</div>

<div id="outline-container-sec-5-1-1" class="outline-4">
<h4 id="sec-5-1-1"></h4>
<div class="outline-text-4" id="text-5-1-1">

<div class="figure">
<p><img src="figures/thread1.png" alt="thread1.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2">Thread-2: Touches FITS data  (verifies selected metadata in archive)</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li><code>[X]</code> all of Thread-1
</li>
<li><code>[X]</code> only transfer files matchin: *.fits.fz 
</li>
<li><code>[X]</code> insure minimum (level 0) set of required metadata fields in FITS
<ul class="org-ul">
<li>minimum acceptable for archive
</li>
</ul>
</li>
<li>On inadequate metadata:
<ul class="org-ul">
<li><code>[X]</code> reject (don't archive) 
</li>
<li><code>[&#xa0;]</code> move to remediation store
</li>
<li><code>[&#xa0;]</code> log error
</li>
</ul>
</li>
<li><code>[X]</code> Test;  Verify all files in mock-IRODS contain required metadata;
</li>
</ul>
</div>

<div id="outline-container-sec-5-2-1" class="outline-4">
<h4 id="sec-5-2-1"></h4>
<div class="outline-text-4" id="text-5-2-1">

<div class="figure">
<p><img src="figures/thread2.png" alt="thread2.png" />
</p>
</div>
</div>
</div>
</div>


<div id="outline-container-sec-5-3" class="outline-3">
<h3 id="sec-5-3">Thread-3: Split into 2 machines, use iRODS client/server</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li><code>[&#xa0;]</code> mock-LPR;  Feed each file in list to Ingest after random delay
</li>
<li><code>[&#xa0;]</code> Ingest; add file to iRODS<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup> on remote machine
</li>
<li><code>[&#xa0;]</code> Verify integrity of file across machines (checksum)
<ul class="org-ul">
<li>Retry N times if integrity violated
</li>
</ul>
</li>
<li><code>[&#xa0;]</code> Test; Verify all iRODS filesystem contains everything from orig
filesystem
</li>
</ul>
</div>



<div id="outline-container-sec-5-3-1" class="outline-4">
<h4 id="sec-5-3-1"></h4>
<div class="outline-text-4" id="text-5-3-1">

<div class="figure">
<p><img src="figures/thread3.png" alt="thread3.png" />
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-sec-5-4" class="outline-3">
<h3 id="sec-5-4">LATER</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>easy to add plugins for scientists 
<ul class="org-ul">
<li>scientist provides program to run against (filtered) set of
images, stores "result" file accessable in archive
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">Classes of supporting machines (hosts)</h2>
<div class="outline-text-2" id="text-6">
<dl class="org-dl">
<dt> T </dt><dd>Telescope; The machine from which observer does the "print". We
<b>can't touch this</b> except to add a printcap entry.
</dd>
<dt> M </dt><dd>Mountain cache; Contains all instrument data that hasn't
successfull made it into the archive. And maybe some that has.
</dd>
<dt> V </dt><dd>Valley; The first stop of data coming from Mountain
</dd>
<dt> A </dt><dd>Archive; the final resting place of the data made available to
scientists. We <b>can't touch this</b> directly. Only by "submit to
ingest". 
</dd>
</dl>

<p>
Roughly, data flows top to bottom through the classes of machines
listed above.  Meaning data is generated at the Telescope, gets
collected at Mountain cache, then transfered to the Valley, and
finally cleaned in submitted to the Archive.
</p>

<p>
There are more than one instance of each of these classes of hosts, so
things get a little more complicated with regard to collecting and
distributing. 
</p>

<p>
Here's a rough schematics of what we end up with.  Arcs represent data
flow.  Note that data only flows bewteen "adjacent" classes of hosts.<sup><a id="fnr.2" name="fnr.2" class="footref" href="#fn.2">2</a></sup>
</p>


<div class="figure">
<p><img src="figures/general-machine-schematic.png" alt="general-machine-schematic.png" />
</p>
</div>
</div>
</div>


<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">Goals</h2>
<div class="outline-text-2" id="text-7">
</div><div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">Prove its done right</h3>
<div class="outline-text-3" id="text-7-1">
<p>
To PROVE we have it right<sup><a id="fnr.3" name="fnr.3" class="footref" href="#fn.3">3</a></sup>, we need good monitoring. To support
courageous code changes, the monitoring should be nearly identical
between:
</p>
<ul class="org-ul">
<li>production
</li>
<li>developmental (to be deployed) system (on VMs or real machines)
</li>
<li>under DES (Discrete Event Simulation)<sup><a id="fnr.4" name="fnr.4" class="footref" href="#fn.4">4</a></sup>
  <a href="file:///home/pothiers/sandbox/dfsim/dfsim.py">dfsim</a>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8">Secondary Goals</h2>
<div class="outline-text-2" id="text-8">
<p>
My primary goal is to develop useful software.  Exactly what that
software will be is unfolding.  It has to be an iterative process. But
regardless of what the software is, there are some secondary goals
that go along with it. Here are most of them:
</p>

<ol class="org-ol">
<li>Documentation as built

<p>
My intent is to provide "as built" design and code documentation. Code
documentation will be generated directly from annotated code. Design
docs will be hand written, with diagrams.  It will include example
runs with inputs and outputs listed. The intended reader for both is
someone that is software tech savvy.
</p>
</li>

<li>Requirements addressed in software as built

<p>
Whatever I develop is intended to address some requirements that I
have in mind.  I'll put those down in a document.  These may be
different than any requirements anyone gives to me because they will
be directly focused on functionality of the software I develop, rather
than on a larger system perspective (which I may have little control
over). The intended reader is management and/or software engineer.
</p>
</li>

<li>Tests

<p>
Each package I write has a "smoke test".  This is a simple script that
can be run by anyone after the software is installed to see that it
works in some fashion.  My smoke tests are not exhaustive regression
tests.  They are intended to be used by developers to ask the
question: "did I break anything with the last change". Smoke tests
include their own test data and are checked into configuration
management with the code.
</p>
</li>

<li>Configuration Management

<p>
All my software will be checked into github or bitbucket. Related
documentation will be included with the code.
</p>
</li>

<li>Auto provisioning of everything I develop

<p>
I'll provide a "vagrant box", or similar, for all my stuff.  This will
allow a new Virtual Machine(s) to be created from scratch and all my
stuff installed on it such that my smoke tests will work on the new
VM(s).
</p>
</li>

<li>Documentation of existing system

<p>
In the process of figuring out what my new stuff has to do, I have to
figure out what the existing stuff does. I don't want to attempt to
hold all that in my head, so I document it.  You've all seen at least
part of my DCI "notes". That is basically the source of what I'm
talking about here.  I don't intend to formalize it any way unless
forced into it. I think it would be too time-consuming/expensive for
me to do and I think I have more the enough technical work on my
plate.  But I will provide at least a crude extraction from my notes
to something that might be useful to others.  The effort I put into
such depends on feedback from you. No feedback means I'll provide
something that is a similar level of informality as the notes I've
already shared with you. I've already exported some parts of that
(like my diagram) to the opswiki.
</p>
</li>

<li>Keep It Super Simple

<p>
Work very hard to keep the structure of the system and code
simple.  If there is a temptation to "optimize", make sure its
worth it. To be worth it, there must be an existing case of
inadequate performance and a requirement must exist to perform at a
quantifiable level that the better than the current one. Before
changing code, <b>measure</b> the system to identify where the ill
performing area is.  Don't add optimatizations unless they are
<b>proven</b> to help meet requirements.
</p>
</li>
</ol>

<hr  />
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9">Requirements</h2>
<div class="outline-text-2" id="text-9">
</div><div id="outline-container-sec-9-1" class="outline-3">
<h3 id="sec-9-1">General systemic requirements</h3>
<div class="outline-text-3" id="text-9-1">
<ol class="org-ol">
<li>Provide all required the functionality of system this replaces
</li>
<li>Resilient 
<ul class="org-ul">
<li>don't break &#x2013; EVER
</li>
</ul>
</li>
<li>Maintainable
<ul class="org-ul">
<li>by new employees without large learning curve
</li>
</ul>
</li>
<li>Operate fast enough (need quantification)
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-9-2" class="outline-3">
<h3 id="sec-9-2">Candidate requirements</h3>
<div class="outline-text-3" id="text-9-2">
<p>
These requirements have <b>not been committed to</b>.  In many case they
need to be made more precise.
</p>

<ul class="org-ul">
<li>All database clients must be capable of reconnecting to database
servers on connection loss (so components can be restarted)
</li>
<li>Increase level of automation of regular operation functions
</li>
<li>use version control always; with commit comments
</li>
<li>elliminate direct changes to live production system (from tagged version)
</li>
<li>(document minimumaly acceptable coding style)
</li>
<li>Implement regression testing (automated where possible, documented otherwise)
</li>
<li>write design documentation
</li>
<li>write installation documentation
</li>
<li>write usage documentation
</li>
<li>reproducible installs
</li>
<li>daily operations must not require manual intervention
</li>
<li>daily operations must not require human monitoring (automatic alerts instead)
</li>
<li>eliminate metadata remmediation in its present form (what form???)
<ul class="org-ul">
<li>get metadata from file format, or
</li>
<li>get metadata from TO/observer/observatory support staff at data
collection time
</li>
</ul>
</li>
<li>insert "archival metadata" just before final archiving (???)
</li>
<li>insert of archival metadata should be idempotent
</li>
<li>eliminate mountain copy coherency requirement (???)
</li>
<li>filename agnostic; nothing in the system should depend on the
structure or uniqueness of a filename
</li>
<li>limit access to internals connection points (ports, databases)
<ul class="org-ul">
<li>perhaps by host, port, user
</li>
</ul>
</li>
<li>literate programming: data flow software and config files: must be
able to auto generate a document that describes the flow (including
connectivity or data-flow diagram).
</li>
<li>Continue to store on mountain if connection to valley is severed.
<ul class="org-ul">
<li>How long? [DEFAULT ANSWER: 7 days]
</li>
<li>Automatically dump stored mountain data to valley when connection
restored
</li>
</ul>
</li>
<li>Mountain machines run unattended. Disk "never" overflows.
<ul class="org-ul">
<li>Data that has been successfully transfered to valley is deleted
from mountain.
</li>
<li>If connection to valley remains severed for extend time and data
continues to be collected on mountain, data will be lost.  How?
[DEFAULT ANSWER: oldest will be thrown away first]
</li>
</ul>
</li>
<li>Data submitted to NSA (archive) must have PROPID that is in the NSA
metadata-DB
<ul class="org-ul">
<li>How is NSA metadata-DB retrieved
</li>
<li>What if PROPID is not in metadata-DB? [DEFAULT ANSWER: File is
moved to remediation store; error logged; no ingest happens]
</li>
</ul>
</li>
<li>Handle "typical" failure modes gracefully with no loss of data:
<ul class="org-ul">
<li>reboot of any machine at any time [IMPORTANT - automate test?]
</li>
<li>Lost of DNS
</li>
<li>filesystem corruption (within "reason")
</li>
</ul>
</li>
<li>Verify no errors on submit of file to archive (NSA) via socket
<ul class="org-ul">
<li>How?
</li>
<li>What does NSA return back?  Does it return error for every case in
which file is not archived?
</li>
</ul>
</li>
<li>Same version of iRODS in TADA as NSA?
<ul class="org-ul">
<li>Not required if API is identical for used commands. 
</li>
<li><a href="http://irods.org/">iRODS</a> says that version 3.+ and 4.+ can be combined in one collection
</li>
</ul>
</li>
<li>Security ???
<ul class="org-ul">
<li>firewalls configured to only allow access to key ports from
trusted hosts
</li>
</ul>
</li>
<li>Files must be renamed according to TBD scheme before submit to
archive
<ul class="org-ul">
<li>How is name derived? 
</li>
<li>Assume name is derived from header &#x2013; but this limits to
processing of FITS (known header info) only.
</li>
</ul>
</li>
<li>allow disabling of auto cache-file expiration
</li>
<li>on "submit to archive" retry N times (N given by config file)
</li>
<li>tests to include simulation of irods stop-delay-start
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-9-3" class="outline-3">
<h3 id="sec-9-3">From 2010 iDCI project definition</h3>
<div class="outline-text-3" id="text-9-3">
<p>
(minor editing done on language of requirements)
</p>

<pre class="example">
iDCI: Integrated Data Cache Initiative
Version 0.1 (02/24/2010)
The [[http://chive.tuc.noao.edu:8080/DPPDOCS/operations-documentation/software-system/application-components/noao-e2e/e2ev1.5/iDCI_project_definition.pdf/at_download/file][PDF]] contains a bit more detail on each requirement.
</pre>

<p>
<b>Status</b> below is per Irene.  Some might not be true anymore. 
</p>

<ol class="org-ol">
<li>Retain the existing DCI configuration, physical and logical
resources. 
<b>Status: Satisfied</b>
<ul class="org-ul">
<li>[-sp-] Need to retain physical resources, but why the logical ones?
</li>
</ul>
</li>
<li>Implement design changes that lower Operations maintenance while
maintaining the overall functionality of the existing DCI.
<b>Status: Not Satisfied</b>
</li>
<li>Provide an interface for external E2E boundary objects.
<b>Status: Satisfied</b>
<ul class="org-ul">
<li>[-sp-] I don't see a well defined/documented interface.
</li>
</ul>
</li>
<li>Guarantee the reliable and immutable transfer of data between all start and
end points controlled by the iDCI.
<b>Status: Satisfied</b>
<ul class="org-ul">
<li>[-sp-] Not happening, unless requirement allows for manual fudging
</li>
</ul>
</li>
<li>Maximize use of available bandwidth for bulk data transfer without
interfering significantly with normal network traffic.
<b>Status: Satisfied</b>
<ul class="org-ul">
<li>[-sp-] Why?  Certainly not "maximized" (maybe "improved")
</li>
</ul>
</li>
<li>Persist the state of pending data transfers across network outages, system
failures and unexpected crashes of the software, recovering automatically once local or
remote services become available.
<b>Status: Satisfied</b>
<ul class="org-ul">
<li>[-sp-] Not happening.  People regularly have to start/restart pieces.
</li>
</ul>
</li>
<li>Be configurable to as to provide flexible routing of data to alternate sites.
<b>Status: Satisfied</b>
<ul class="org-ul">
<li>[-sp-] At what touch point?  I don't see any way of doing this
simply by changing a config file.
</li>
</ul>
</li>
<li>Provide a means to monitor and change the state of the system by
operations staff.
<b>Status: Not Satisfied</b>
</li>
<li>Provide a choice of transfer protocols to be used, allowing the operator
to choose a protocol
<b>Status: Somewhat Satisfied</b>
<ul class="org-ul">
<li>[-sp-] Why? What is the operational requirement hidden in this?
Speed? Bandwidth? Quantify.
</li>
</ul>
</li>
</ol>
</div>
</div>


<div id="outline-container-sec-9-4" class="outline-3">
<h3 id="sec-9-4">TADA migration from 2010 iDCI project requriements</h3>
<div class="outline-text-3" id="text-9-4">
<ol class="org-ol">
<li>Retain existing physical resources
</li>
<li>ACCEPTED. Improve upon iDCI. Qualify. Quantify
</li>
<li>REJECTED. Except: will submit ingest to archive
</li>
<li>ACCEPTED. Improve upon iDCI. Qualify. Quantify
</li>
<li>REJECTED. If there is a bandwidth requirement, add as such.
</li>
<li>ACCEPTED with caveats.
</li>
<li>REJECTED. Not a requirement, but a goal I expect to happen.
</li>
<li>REJECTED. Not clear.
</li>
<li>REJECTED. No need.
</li>
</ol>
</div>
</div>





<div id="outline-container-sec-9-5" class="outline-3">
<h3 id="sec-9-5">Meta data required for ingest into archive</h3>
<div class="outline-text-3" id="text-9-5">
<ul class="org-ul">
<li><code>[&#xa0;]</code> PROPID
</li>
<li><code>[&#xa0;]</code> DATE-OBS
</li>
<li><code>[&#xa0;]</code> DTTITLE
</li>
<li><code>[&#xa0;]</code> DTACQNAM
</li>
<li><code>[&#xa0;]</code> DTNSANAM
</li>
<li><code>[&#xa0;]</code> DTINSTRU
</li>
<li><code>[&#xa0;]</code> DTTELESC
</li>
<li><code>[&#xa0;]</code> DTSITE
</li>
<li><code>[&#xa0;]</code> DTUTC
</li>
<li><code>[&#xa0;]</code> DTPI
</li>
<li><code>[&#xa0;]</code> DTSITE
</li>
</ul>

<p>
from <a href="https://support.sdm.noao.edu/browse/OPS-1991">https://support.sdm.noao.edu/browse/OPS-1991</a>
</p>
</div>
</div>


<div id="outline-container-sec-9-6" class="outline-3">
<h3 id="sec-9-6">MVP - Minimally Viable Product</h3>
<div class="outline-text-3" id="text-9-6">
<p>
These are the absolute minium requirements for a DCI replacement.
When ever possible, avoid putting anything here that is an absolutely
essential requirement. (push "would be nice" stuff into subsequent
release)
</p>

<ol class="org-ol">
<li>Baring fatal hardware failure, every file produced by instrument
gets into archive
</li>
<li></li>
</ol>
</div>
</div>

<div id="outline-container-sec-9-7" class="outline-3">
<h3 id="sec-9-7">Release 2</h3>
<div class="outline-text-3" id="text-9-7">
<ol class="org-ol">
<li>Each site is "independent"
<ul class="org-ul">
<li>What is a "site"?
</li>
<li>How independent do they have to be? (archive depends on telescope,
for instance)
</li>
</ul>
</li>
<li>Must be able to re-route around broken machines
</li>
<li>Allow institutions direct access to iRODS data ("back-door")
</li>
</ol>
</div>
</div>

<div id="outline-container-sec-9-8" class="outline-3">
<h3 id="sec-9-8">Deferred requirements</h3>
<div class="outline-text-3" id="text-9-8">
<ul class="org-ul">
<li><b>Dashboard</b> for monitoring health of TADA system
<ul class="org-ul">
<li>web based
</li>
</ul>
</li>
<li>Support for analytics
<ul class="org-ul">
<li>shared results (algorithms run against data from archive)
</li>
<li>loose coupling of archive data to results
</li>
<li>auto expire of results (warning 1, warning 2, delete)
</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10">Open Issues</h2>
<div class="outline-text-2" id="text-10">
</div><div id="outline-container-sec-10-1" class="outline-3">
<h3 id="sec-10-1">Which files from input list ("printed" files) should get moved to archive?</h3>
<div class="outline-text-3" id="text-10-1">
<ul class="org-ul">
<li><code>[&#xa0;]</code> All of them?
</li>
<li><code>[&#xa0;]</code> *.fits.fz?
</li>
<li><code>[&#xa0;]</code> *.fits?
</li>
<li><code>[&#xa0;]</code> *.hdr
</li>
<li>DEFAULT ANSWER: only *.fitz.fz
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-2" class="outline-3">
<h3 id="sec-10-2">What if FITS files do NOT contain minimum required metadata (fields/values)?</h3>
<div class="outline-text-3" id="text-10-2">
<ul class="org-ul">
<li>Insert dummy (not realistic) values.
</li>
<li>Calculate values. How?
</li>
<li>Reject file (report and do not archive)
</li>
<li>DEFAULT ANSWER: Reject file, move to remediation store, log error
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-10-3" class="outline-3">
<h3 id="sec-10-3">What are the expected workflows?</h3>
<div class="outline-text-3" id="text-10-3">
<p>
For instance:
</p>
<ul class="org-ul">
<li>Load Proposal ID, etc.
</li>
<li>Reingest remediated files.  a) mountain, b) valley
</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-sec-11" class="outline-2">
<h2 id="sec-11">Closed Issues</h2>
<div class="outline-text-2" id="text-11">
<p>
<b><i>&lt;NONE&gt;</i></b>
</p>
</div>
</div>

<div id="outline-container-sec-12" class="outline-2">
<h2 id="sec-12">Assumptions</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li>Number of users of an instances of this system is very small (under
20).  "Users" in this case are data-managent operators of some
sort.  People that make sure the data is still flowing and correct
problems as they come up (which should be very rare).
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-13" class="outline-2">
<h2 id="sec-13">DEFERRED</h2>
<div class="outline-text-2" id="text-13">
</div><div id="outline-container-sec-13-1" class="outline-3">
<h3 id="sec-13-1">(mountain) copy and morph</h3>
<div class="outline-text-3" id="text-13-1">
<p>
Copy the files from the ASTRO created file structure into a structure
that mirrors the old iDCI directory tree.
</p>
<pre class="example">
/mtncache/fits/&lt;DATE&gt;/&lt;TELESCOPE&gt;/&lt;PROPID&gt;/&lt;datafile&gt;
</pre>
<p>
This will require reading FITS header to get the fields and some may
not even be there.  Implications: more software packages to load, more
edge conditions.  This should be done as a complete seperate process.
I won't break anything else since its just grabbing a copy and
stashing it. 
</p>
</div>
</div>
<div id="outline-container-sec-13-2" class="outline-3">
<h3 id="sec-13-2">FPACK before transmit from Mountain to Valley</h3>
<div class="outline-text-3" id="text-13-2">
<p>
Compress FITS files before transmitting.   Since we use irsync (as of
this writing) to move files from M-&gt;V, this needs to be done in place
for all non-compressed FITS files in the directory tree <b>before</b> the
irsync is done.
</p>
</div>
</div>
<div id="outline-container-sec-13-3" class="outline-3">
<h3 id="sec-13-3">sdpost writes to /tmp/mountaincache</h3>
<div class="outline-text-3" id="text-13-3">
<p>
Might be better to write to non-/tmp directory.  But there are
security issues related to such which I didn't spend the time to
understand. Just setting the setuid bit of the backend end 
</p>
<pre class="example">
sudo chmod u+s /usr/lib/cups/backend/sdpost 
</pre>
<p>
is <b>not</b> good as CUPS traps such as a potential security hole.
</p>

<p>
Other cleanup needed in sdpost.  See reference files at top of script.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-14" class="outline-2">
<h2 id="sec-14">Release checklist</h2>
<div class="outline-text-2" id="text-14">
</div><div id="outline-container-sec-14-1" class="outline-3">
<h3 id="sec-14-1">Maintainability</h3>
<div class="outline-text-3" id="text-14-1">
<ul class="org-ul">
<li><code>[&#xa0;]</code> Documentation as built
</li>
<li><code>[&#xa0;]</code> Requirements addressed in software as built
</li>
<li><code>[&#xa0;]</code> Tests
</li>
<li><code>[&#xa0;]</code> Configuration Management
</li>
<li><code>[&#xa0;]</code> Auto provisioning of everything I develop
</li>
<li><code>[&#xa0;]</code> Documentation of existing system
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
<a href="http://irods.org">iRODS</a> 4.x;  4.0 was release April 4, 2014; 4.0.3 released Aug
20, 2014
</p></div>

<div class="footdef"><sup><a id="fn.2" name="fn.2" class="footnum" href="#fnr.2">2</a></sup> <p class="footpara">
In the NOAO case, these hosts map to the following: T1=Mayall
4m, M1=Kitt Peak, V1=Tucson, T2=SOAR, T3=Blanco 4m, M2=Cerro Pachon,
M3=Cerro Tololo; V2=La Serena
</p></div>

<div class="footdef"><sup><a id="fn.3" name="fn.3" class="footnum" href="#fnr.3">3</a></sup> <p class="footpara">
SDM is responsibly managing data, nothing is being lost, its
going where it should, rates and sizes of data are as expected, manual
intervention is not <b>required</b> except in the most unusual circumstances
(expected 2-4 times per YEAR). Code changes can be made with courage,
without doubt or fear of breaking something.
</p></div>

<div class="footdef"><sup><a id="fn.4" name="fn.4" class="footnum" href="#fnr.4">4</a></sup> <p class="footpara">
<a href="https://simpy.readthedocs.org/en/latest/">https://simpy.readthedocs.org/en/latest/</a>
</p></div>


</div>
</div></div>
<div id="postamble" class="status">
<p class="author">Author: Steve Pothier</p>
<p class="date">Created: 2014-11-07 Fri 08:50</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 24.4.1 (<a href="http://orgmode.org">Org</a> mode 8.2.10)</p>
<p class="validation"></p>
</div>
</body>
</html>
